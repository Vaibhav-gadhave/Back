Samba4 with RSAT


Please refer the website : 1. https://adamtheautomator.com/samba-active-directory/
                           2. https://www.considerednormal.com/2022/11/samba-based-active-directory-on-ubuntu-22-04/


Steps to do
Network ip: 172.16.1.10
Subnet: 255.255.255.0
Gateway: 172.16.1.10

1. set up the hostname
# hostnamectl set-hostname dc1

2. setup FQDN dc1.example.lan
# 172.16.1.10 dc1.example.lan dc1

3. verify FQDN
# hostname -f

   verify FQDN is resolved to the Samba IP address
#  ping -c3 dc1.example.lan

4. stop and disable systemd-resolved service
#  sudo systemctl disable --now systemd-resolved

remove the symlink file /etc/resolv.conf
#  sudo unlink /etc/resolv.conf

5. create a new /etc/resolv.conf file
# touch /etc/resolv.conf
------------------------------------------------
# Samba server IP address
nameserver 172.16.1.10

# fallback resolver
nameserver 1.1.1.1

# main domain for Samba
search example.lan
------------------------------------------------

6. add attribute immutable to the file /etc/resolv.conf
# sudo chattr +i /etc/resolv.conf

############################Installing Samba##############################

7.# sudo apt update

8.# sudo apt install -y acl attr samba samba-dsdb-modules samba-vfs-modules smbclient winbind libpam-winbind libnss-winbind libpam-krb5 krb5-config krb5-user dnsutils chrony net-tools

9. Type the default realm domain name in uppercase. In this example, the FQDN is dc1.example.lan, so the default realm domain name should be EXAMPLE.LAN. Highlight Ok and press Enter. 

10. On the next prompt, type the server FQDN. This step defines the default Kerberos server. so the default realm domain name should be dc1.example.lan. Highlight Ok and press Enter. 

11. Next, type the server FQDN again to specify the Kerberos administrative server. so the default realm domain name should be dc1.example.lan. Highlight Ok, and press Enter to complete the initial Samba configuration. 

12. stop and disable samba services - smbd, nmbd, and winbind
# sudo systemctl disable --now smbd nmbd winbind

13. activate samba-ad-dc service
# sudo systemctl unmask samba-ad-dc

enable samba-ad-dc service
# sudo systemctl enable samba-ad-dc

Configuring Samba Active Directory

1. backup default Samba configuration file
# sudo mv /etc/samba/smb.conf /etc/samba/smb.conf.orig

2. provisioning Samba Active Directory
# sudo samba-tool domain provision

3. On the Realm prompt, accept the default value and press Enter.

4. On the Domain prompt, press Enter again to accept the default value.

5. On the Server role prompt, leave the default and press Enter.

6. On the DNS backend prompt, leave the value as default (SAMBA_INTERNAL) and press Enter.

7. Next, type the additional DNS forwarder IP address. This example will add the Cloudflare DNS 1.1.1.1 as the DNS forwarder. This option is only available when you’re using the SAMBA_INTERNAL DNS backend.

8. Type in your Samba Active Directory Administrator password and press Enter. 

9.rename default Kerberos configuration to krb5.conf.orig
# sudo mv /etc/krb5.conf /etc/krb5.conf.orig

 copy the Kerberos configuration generated by the samba-tool
# sudo cp /var/lib/samba/private/krb5.conf /etc/krb5.conf

10. start samba-ad-dc service
# sudo systemctl start samba-ad-dc

  verify samba-ad-dc service
# sudo systemctl status samba-ad-dc

Setting Up Time Synchronisation

1.allow group _chrony to read the directory ntp_signd
# sudo chown root:_chrony /var/lib/samba/ntp_signd/

  change the permission of the directory ntp_signd
# sudo chmod 750 /var/lib/samba/ntp_signd/

2. vim /etc/chrony/chrony.conf
------------------------------------------------------------------------------
# bind the chrony service to IP address of the Samba AD
bindcmdaddress 172.16.1.10

# allow clients on the network to connect to the Chrony NTP server
allow 172.16.1.0/24

# specify the ntpsigndsocket directory for the Samba AD
ntpsigndsocket /var/lib/samba/ntp_signd
-------------------------------------------------------------------------------

3. restart chronyd service
# sudo systemctl restart chronyd

  verify chronyd service status
# sudo systemctl status chronyd

###########################Verifying Samba Active Directory##############################

1.verify domain example.lan
# host -t A example.lan

 verify domain dc1.example.lan
# host -t A dc1.example.lan

2. verify SRV record for _kerberos
# host -t SRV _kerberos._udp.example.lan

 verify SRV record for _ldap
# host -t SRV _ldap._tcp.example.lan

3. checking available resources on Samba AD
# smbclient -L example.lan -N

4. authenticate to Kerberos using administrator
# kinit administrator@EXAMPLE.LAN

 verify list cached Kerberos tickets
# klist

#####################Creating a New Samba Active Directory User#########################

1. create a new user in Samba
# sudo samba-tool user create alice alice_password88

2. checking users on Samba
# sudo samba-tool user list

#######################Joining and Logging In to Samba Active Directory Domain#################

1. Log in to your Windows PC and open PowerShell as administrator. 

2. Run the below command to list the available ethernet adapters on your Windows PC. 
   checking available interface using Powershell command
#   Get-NetAdapter -Name "*"

3. setup DNS resolver using Powershell
#  Set-DNSClientServerAddress "Ethernet1" –ServerAddresses ("172.16.1.10","1.1.1.1")

4. verify DNS resolver
#  Get-DnsClientServerAddress

5. ping the AD domain dc1.example.lan
# ping dc1.example.lan

 ping the AD domain example.lan
# ping example.lan
 
6. add Windows 10 to Active Directory
# Add-Computer -DomainName "example.lan" -Restart

Install RSAT to administer domain from Windows

Download RSAT tools <– For Windows 10 – Could not find a DL source for Windows 11, something I need to look into.

link for RSAT: https://www.microsoft.com/en-us/download/details.aspx?id=45520

------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------






































